<?php

/**
 * @file
 * Simpletest for testing the Media Fotoweb module.
 */

/**
 * Tests, that the admin settings for the expected configuration are existing.
 */
class MediaFotowebAdminSettingsTestCase extends DrupalWebTestCase {

  protected $privilegedUser;

  /**
   * Defines the simpletest.
   */
  public static function getInfo() {
    return array(
      'name' => 'Media Fotoweb admin settings',
      'description' => 'Test media fotoweb administration page functionality.',
      'group' => 'Media Fotoweb',
    );
  }

  /**
   * Sets up the fixture.
   */
  public function setUp() {
    parent::setUp('media_fotoweb');
    $this->privilegedUser = $this->drupalCreateUser(array(
      'administer media_fotoweb settings',
    ));
    $this->drupalLogin($this->privilegedUser);
  }

  /**
   * Tests if the expected setting fields are existing in the form.
   */
  public function testAdminSettingsForm() {
    $this->drupalGet('admin/config/media/fotoweb');
    $this->assertResponse(200, 'User is allowed to access the settings page.');
    $this->assertFieldByXpath("//form[@id='media-fotoweb-admin-settings']//input[@name='media_fotoweb_server']", '', 'Server field is present.');
    $this->assertFieldByXpath("//form[@id='media-fotoweb-admin-settings']//input[@name='media_fotoweb_full_api_key']", '', 'Full API Key field is present.');
    $this->assertFieldByXpath("//form[@id='media-fotoweb-admin-settings']//input[@name='media_fotoweb_selection_widget_use_sso']", '', 'Full API Key field is present.');
    $this->assertFieldByXpath("//form[@id='media-fotoweb-admin-settings']//input[@name='media_fotoweb_encryption_secret']", '', 'Encryption secret field is present.');
    $this->assertFieldByXpath("//form[@id='media-fotoweb-admin-settings']//input[@name='media_fotoweb_selection_widget_height']", '500', 'Widget height field is present.');
    $this->assertFieldByXpath("//form[@id='media-fotoweb-admin-settings']//select[@name='media_fotoweb_file_storage_type']", 'preview', 'Storage selection field is present.');
    $this->assertFieldByXpath("//form[@id='media-fotoweb-admin-settings']//input[@name='media_fotoweb_local_file_size_threshold']", '1500', 'File size threshold field is present.');
    $this->assertFieldByXpath("//form[@id='media-fotoweb-admin-settings']//select[@name='media_fotoweb_asset_update_trigger']", 'new', 'Asset update trigger field is present.');
  }

}

/**
 * Checks the interaction of the StreamWrapper with Drupal helper functions.
 */
class MediaFotowebStreamWrapperTest extends DrupalWebTestCase {

  protected $classname = 'FotowebStreamWrapper';
  protected $scheme = 'fotoweb';

  /**
   * Defines the Simpletest.
   */
  public static function getInfo() {
    return array(
      'name' => 'Media Fotoweb Stream Wrapper',
      'description' => 'Tests fotoweb stream wrapper functions.',
      'group' => 'Media Fotoweb',
    );
  }

  /**
   * Sets up the fixture.
   */
  public function setUp() {
    parent::setUp('media_fotoweb');
    drupal_static_reset('file_get_stream_wrappers');
  }

  /**
   * Test to get the correct class name.
   */
  public function testGetClassName() {
    $this->assertEqual($this->classname, file_stream_wrapper_get_class($this->scheme), 'Got correct class name for fotoweb scheme.');
  }

  /**
   * Test, that the StreamWrapper returns the expected scheme.
   */
  public function testGetInstanceByScheme() {
    $instance = file_stream_wrapper_get_instance_by_scheme($this->scheme);
    $this->assertEqual($this->classname, get_class($instance), 'Got correct class type for fotoweb scheme.');
  }

  /**
   * Test that the instantiation of the StreamWrapper with a scheme is working.
   */
  public function testUriFunctions() {
    $instance = file_stream_wrapper_get_instance_by_uri($this->scheme . '://foo');
    $this->assertEqual($this->classname, get_class($instance), 'Got correct class type for fotoweb URI.');

    $this->assertEqual(file_stream_wrapper_get_instance_by_scheme('fotoweb')->getDirectoryPath(), variable_get('file_public_path', conf_path() . '/files') . '/media-fotoweb', 'Expected fotoweb directory path was returned.');
  }

}
